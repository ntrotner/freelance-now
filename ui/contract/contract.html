<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contract</title>
    <script src="sidebar.js" defer></script>
    <link rel="stylesheet" href="default.css">
    <link rel="stylesheet" href="contract.css">
    <link rel="stylesheet" href="snackbar.css">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<sidebar-component></sidebar-component>

<main>
    <table>
        <tr>
            <td>Title</td>
            <td id="name"></td>
        </tr>
        <tr>
            <td>Entlohnung</td>
            <td id="reward"></td>
        </tr>
        <tr>
            <td>Fertig</td>
            <td id="isDone"></td>
        </tr>

        <tr>
            <td>Skills</td>
            <td id="stack"></td>
        </tr>

        <tr>
            <td>Start</td>
            <td id="starting_date"></td>
        </tr>

        <tr>
            <td>Ende</td>
            <td id="end_date"></td>
        </tr>

        <tr>
            <td>Beschreibung</td>
            <td id="description"></td>
        </tr>
    </table>
    <div>
        <div id="finish" class="shadow">
            <label for="progress">In Arbeit</label>
            <input type="radio" id="progress" name="status" value="In Arbeit">
            <label for="done">Fertig</label>
            <input type="radio" id="done" name="status" value="Fertig">

            <div id="communication">
                <p>Kommunikation</p>
                <div>
                    <span onclick="takeFirstNStars('communication', 1)" id="c1" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('communication', 2)" id="c2" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('communication', 3)" id="c3" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('communication', 4)" id="c4" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('communication', 5)" id="c5" class="fa fa-star"></span>
                </div>
            </div>

            <div id="speed">
                <p>Geschwindigkeit</p>
                <div>
                    <span onclick="takeFirstNStars('speed', 1)" id="s1" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('speed', 2)" id="s2" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('speed', 3)" id="s3" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('speed', 4)" id="s4" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('speed', 5)" id="s5" class="fa fa-star"></span>
                </div>
            </div>
            <div id="quality">
                <p>Qualität</p>
                <div>
                    <span onclick="takeFirstNStars('quality', 1)" id="q1" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('quality', 2)" id="q2" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('quality', 3)" id="q3" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('quality', 4)" id="q4" class="fa fa-star"></span>
                    <span onclick="takeFirstNStars('quality', 5)" id="q5" class="fa fa-star"></span>
                </div>
            </div>
            <button id="submit">Abschließen</button>
        </div>

        <div id="devs" class="shadow">
            <h4 id="devsTitle">Entwickler Auswählen</h4>
        </div>

        <div id="apply" class="shadow">
            <h4 id="applyTitle">Bewerben für den Auftrag</h4>
            <div class="inputWrapper">
                <input type="number" min="0.00" step="0.01" name="reward" id="rewardInput">
                €
            </div>
            <button id="newOffer">Bieten</button>
        </div>

    </div>
</main>

<script type="text/javascript">
    function takeFirstNStars(selector, n) {
        $(`#${selector} > div > span:nth-child(n)`).attr('class', 'fa fa-star')
        $(`#${selector} > div > span:nth-child(-n+${n})`).attr('class', 'fa fa-star checked')
    }
</script>

<script type="module">
    import {getContract, sendFinishContract, selectDeveloper, sendDeveloperReward} from './contracts.js';
    import {prettifySkill} from './profile.js';
    import {callSnackbar} from './snackbar.js';
    import {redirect} from './session_manager.js';


    const _id = (new URLSearchParams(window.location.search)).get('_id')

    document.getElementById('submit')
        .addEventListener("click", finishContract);

    document.getElementById('newOffer')
        .addEventListener("click",
            () => sendDeveloperReward(_id, sessionStorage.getItem('email'), document.getElementById('rewardInput').value,
                (response) => {
                    redirect(`/contract?_id=${_id}`);
                }, (error) => console.error(error)));

    function finishContract() {
        const communication = $(`#communication > div > .checked`).length
        const speed = $(`#speed > div > .checked`).length
        const quality = $(`#quality > div > .checked`).length
        const isChecked = document.getElementById('done').checked
        if (!isChecked) return callSnackbar('Der Auftrag kann nur abgeschlossen werden wenn er fertig ist')
        if (!communication || !speed || !quality) return callSnackbar('Bitte bewerten Sie den Entwickler')

        sendFinishContract(_id, communication, speed, quality,
            (response) => {
                redirect(`/contract?_id=${_id}`);
            },
            (error) => callSnackbar(error)
        )
    }

    getContract(_id,
        (response) => {
            console.log(response)
            Object.keys(response).forEach((key) => {
                if (key === 'reward') {
                    document.getElementById(key).innerText = response[key] + '€'
                    return
                }

                if (['starting_date', 'end_date'].includes(key)) {
                    document.getElementById(key).innerText = (new Date(response[key])).toLocaleDateString()
                    return
                }

                if (key === 'isDone') {
                    document.getElementById(key).innerText = response[key] ? 'Abgeschlossen' : 'Nein'
                    if (response[key]) $('#apply').remove()

                    if (response[key] || (sessionStorage.getItem('type') == 'dev')) {
                        $('#finish').remove()
                        $('#devs').remove()
                    }
                    return
                }

                if (key === 'potentialDevelopers') {
                    if (response[key].length === 0 && response.developer) {
                        $('#devs').remove()
                        return
                    }

                    response[key].forEach((dev) => {
                        $('#devs')
                            .append($('<div>').attr('class', 'dev').click(() => {
                                    selectDeveloper(_id, dev.email, dev.reward,
                                        (response) => redirect(`/contract?_id=${_id}`),
                                        (error) => console.error(error)
                                    );
                                })
                                    .append($('<p>').text(dev.email))
                                    .append($('<p>').text(`Entlohnung: ${dev.reward}€`))
                            )

                    })
                    return
                }

                if (key === 'details') {
                    Object.keys(response[key]).forEach((key2) => {
                        try {
                            if (key2 === 'stack') {
                                document.getElementById(key2).innerText =
                                    response[key][key2].map((skill) => prettifySkill(skill))
                                return;
                            }
                            document.getElementById(key2).innerText = response[key][key2]
                        } catch {
                            console.log("Skip Element")
                        }
                    });
                    return
                }
                try {
                    document.getElementById(key).innerText = response[key]
                } catch {
                    console.log("Skip Element")
                }
            })
        },
        (error) => console.error(error))

    if (sessionStorage.getItem('type') === 'client') $('#apply').remove()
</script>
<div id="snackbar"></div>
</body>
</html>
